// jenkins/Jenkinsfile
pipeline {
    agent any

    environment {
        IMAGE_NAME = 'meu-app-django'
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig-kind'
        K8S_NAMESPACE = 'default'
        SONARQUBE_SERVER = 'SonarQube Local'
    }

    stages {
        stage('Checkout') {
            agent any
            steps {
                echo 'Clonando o repositório...'
                checkout scm
            }
        }

        stage('Build Docker Image') {
            agent {
                docker {
                    image 'docker:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                echo "Construindo a imagem Docker: ${IMAGE_NAME}:${env.BUILD_NUMBER}"
                script {
                    def dockerImage = docker.build("${IMAGE_NAME}:${env.BUILD_NUMBER}", "./app")
                }
            }
        }

        stage('Load Image into Kind') {
            agent any
            when {
                expression { true }
            }
            steps {
                echo "Carregando imagem ${IMAGE_NAME}:${env.BUILD_NUMBER} no cluster Kind..."
                sh "kind load docker-image ${IMAGE_NAME}:${env.BUILD_NUMBER} --name staging-cluster"
            }
        }

        stage('Test Application') {
            agent any
            steps {
                echo "Executando testes via docker run..."
                sh """
                    docker run --rm \
                        -w /app \
                        --entrypoint="" \
                        ${IMAGE_NAME}:${env.BUILD_NUMBER} \
                        python manage.py check
                """
            }
        }

        stage('SonarQube Analysis') {
            agent {
                docker {
                    image 'sonarsource/sonar-scanner-cli:latest'
                    args '--network=meu-projeto-devops_jenkins_net' // Nome da rede ajustado
                }
            }
            steps {
                echo "Executando análise SonarQube..."
                withSonarQubeEnv(SONARQUBE_SERVER) {
                    sh """
                        sonar-scanner \
                          -Dsonar.projectKey=django-crm-app \
                          -Dsonar.sources=./app \
                          -Dsonar.host.url=${env.SONAR_HOST_URL} \
                          -Dsonar.login=${env.SONAR_AUTH_TOKEN} \
                          -Dsonar.projectName='Django CRM Application' \
                          -Dsonar.sourceEncoding=UTF-8 \
                          -Dsonar.python.version=3.9
                    """
                }
            }
        }

        stage('Quality Gate') {
            agent any
            steps {
                echo "Verificando SonarQube Quality Gate..."
                timeout(time: 10, unit: 'MINUTES') {
                    def qg = waitForQualityGate()
                    if (qg.status != 'OK') {
                        error "Pipeline abortado devido à falha no Quality Gate: ${qg.status}"
                    } else {
                        echo "Quality Gate passou!"
                    }
                }
            }
        }

        stage('Deploy to Kubernetes (Kind)') {
            agent any
            steps {
                echo "Implantando no Kubernetes (Namespace: ${K8S_NAMESPACE})..."
                withKubeConfig([credentialsId: KUBECONFIG_CREDENTIALS_ID]) {
                    sh "sed -i 's|image: .*|image: ${IMAGE_NAME}:${env.BUILD_NUMBER}|g' infra/k8s/deployment.yaml"

                    echo "Aplicando deployment..."
                    sh "kubectl apply -f infra/k8s/deployment.yaml --namespace ${K8S_NAMESPACE}"
                    echo "Aplicando service..."
                    sh "kubectl apply -f infra/k8s/service.yaml --namespace ${K8S_NAMESPACE}"
                    echo "Aplicando ingress..."
                    sh "kubectl apply -f infra/k8s/ingress.yaml --namespace ${K8S_NAMESPACE}"

                    echo "Verificando rollout do deployment..."
                    sh "kubectl rollout status deployment/django-crm-app --namespace ${K8S_NAMESPACE} --timeout=120s"
                }
            }
        }

    }

    post {
        always {
            echo 'Pipeline finalizado.'
        }
        success {
            echo 'Pipeline executado com sucesso!'
        }
        failure {
            echo 'Pipeline falhou!'
        }
    }
}
